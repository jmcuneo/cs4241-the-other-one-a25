<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <style>
            .bar {
                fill: steelblue;
            }
            .bar:hover {
                fill: orange;
            }
            .axis {
                font: 10px sans-serif;
            }
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
            .x.axis path {
                display: none;
            }
            .x.axis text {
                transform: rotate(-45deg);
                text-anchor: end;
            }
            .tooltip {
                position: absolute;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 5px;
                border-radius: 3px;
                pointer-events: none;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <h1>USA GDP Over Time (Current US$)</h1>
        <div id="chart"></div>
        <script>
            d3.json("/matthew/data/gdp.json", function (error, data) {
                if (error) throw error;

                const gdpData = data[1];

                const processedData = gdpData
                    .filter((d) => d.value !== null)
                    .map((d) => ({
                        year: +d.date,
                        gdp: d.value / 1e12, // Convert to trillions
                    }))
                    .sort((a, b) => a.year - b.year);

                console.log("Processed GDP data:", processedData);

                const margin = { top: 20, right: 30, bottom: 80, left: 70 };
                const width = 1200 - margin.left - margin.right;
                const height = 500 - margin.top - margin.bottom;

                const svg = d3
                    .select("#chart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")",
                    );

                const xScale = d3
                    .scaleBand()
                    .domain(processedData.map((d) => d.year))
                    .range([0, width])
                    .padding(0.1);

                const yScale = d3
                    .scaleLinear()
                    .domain([0, d3.max(processedData, (d) => d.gdp)])
                    .nice()
                    .range([height, 0]);

                const xAxis = d3.axisBottom(xScale).tickValues(
                    processedData
                        .filter((d, i) => i % 5 === 0) // Show every 5th year
                        .map((d) => d.year),
                );

                const yAxis = d3.axisLeft(yScale);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                svg.append("g").attr("class", "y axis").call(yAxis);

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - height / 2)
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("GDP (Trillions USD)");

                svg.append("text")
                    .attr(
                        "transform",
                        "translate(" +
                            width / 2 +
                            " ," +
                            (height + margin.bottom - 10) +
                            ")",
                    )
                    .style("text-anchor", "middle")
                    .text("Year");

                const tooltip = d3
                    .select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                svg.selectAll(".bar")
                    .data(processedData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", (d) => xScale(d.year))
                    .attr("width", xScale.bandwidth())
                    .attr("y", (d) => yScale(d.gdp))
                    .attr("height", (d) => height - yScale(d.gdp))
                    .on("mouseover", function (d) {
                        tooltip
                            .transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip
                            .html(
                                "Year: " +
                                    d.year +
                                    "<br/>" +
                                    "GDP: $" +
                                    d.gdp.toFixed(2) +
                                    " Trillion",
                            )
                            .style("left", d3.event.pageX + 10 + "px")
                            .style("top", d3.event.pageY - 28 + "px");
                    })
                    .on("mouseout", function (d) {
                        tooltip.transition().duration(500).style("opacity", 0);
                    });
            });
        </script>
    </body>
</html>
